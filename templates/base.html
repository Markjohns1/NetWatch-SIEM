<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NetWatch SIEM{% endblock %} | Network Monitoring</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%233b82f6;stop-opacity:1'/><stop offset='100%25' style='stop-color:%231e40af;stop-opacity:1'/></linearGradient></defs><rect width='64' height='64' rx='12' fill='%230f172a'/><rect x='22' y='18' width='20' height='24' rx='2' fill='none' stroke='url(%23grad1)' stroke-width='2'/><rect x='24' y='20' width='16' height='16' fill='%231e293b'/><rect x='26' y='23' width='4' height='3' fill='%233b82f6' opacity='0.8'/><rect x='32' y='23' width='4' height='3' fill='%233b82f6' opacity='0.6'/><rect x='26' y='28' width='4' height='3' fill='%2310b981' opacity='0.8'/><rect x='32' y='28' width='4' height='3' fill='%23f59e0b' opacity='0.7'/><rect x='26' y='33' width='10' height='2' fill='%233b82f6' opacity='0.5'/><path d='M 28 42 L 28 46 L 24 48 L 28 50 L 28 54' stroke='%2310b981' stroke-width='2' fill='none' stroke-linecap='round'/><path d='M 36 42 L 36 46 L 40 48 L 36 50 L 36 54' stroke='%2310b981' stroke-width='2' fill='none' stroke-linecap='round'/><circle cx='32' cy='48' r='2' fill='%2310b981'/><circle cx='12' cy='32' r='1.5' fill='%233b82f6' opacity='0.6'/><circle cx='52' cy='32' r='1.5' fill='%233b82f6' opacity='0.6'/><line x1='14' y1='32' x2='20' y2='32' stroke='%233b82f6' stroke-width='1' opacity='0.4'/><line x1='44' y1='32' x2='50' y2='32' stroke='%233b82f6' stroke-width='1' opacity='0.4'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cyber-theme.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen bg-darker">
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 border-b border-slate-700">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center gap-4">
                <div class="flex items-center space-x-2">
                    <button id="menuToggle" class="lg:hidden text-slate-300 hover:text-white mr-3">
                        <i data-feather="menu" class="w-6 h-6"></i>
                    </button>
                    <i data-feather="shield" class="text-blue-500"></i>
                    <h1 class="text-lg md:text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                        NetWatch SIEM
                    </h1>
                </div>
                
                <!-- Global Search Bar -->
                <div class="flex-1 max-w-md mx-4 relative hidden md:block">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="globalSearchInput"
                            placeholder="Search devices (IP, MAC, Name)..." 
                            class="w-full px-4 py-2 pl-10 pr-10 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500"
                            autocomplete="off"
                        >
                        
                        <button 
                            id="globalClearBtn" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300 hidden"
                            onclick="clearGlobalSearch()"
                        >
                            <i data-feather="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    
                    <div id="globalSearchResults" class="absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50 hidden">
                        <div class="p-4 text-center text-slate-400 text-sm">
                            Start typing to search devices...
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4">
                    <div class="hidden lg:block text-sm">
                        <span class="text-slate-400">{{ gettext('last_scan') }}</span>
                        <span class="font-mono text-emerald-400" id="lastScanTime"></span>{{ gettext('live_scanning') }}</span>
                        <span class="active_scanning">
                    </div>
                    
                    <!-- Language Selector -->
                    <div class="relative">
                        <select id="languageSelector" class="bg-slate-800 border border-slate-700 rounded text-xs text-slate-200 px-2 py-1 focus:outline-none focus:border-blue-500">
                            <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
                            <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                            <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                            <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                            <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                        </select>
                    </div>
                    
                    <button id="scanNowBtn" class="px-2 md:px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs md:text-sm">
                       {{ gettext('scan_now') }}
                    </button>
                    <a href="/logout" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600">
                        <i data-feather="log-out" class="w-4 h-4"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div id="mobileMenu" class="lg:hidden fixed inset-0 bg-black/50 z-50 hidden">
        <div class="bg-slate-900 w-64 h-full p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-blue-400">Menu</h2>
                <button id="menuClose" class="text-slate-400 hover:text-white">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Mobile Search -->
            <div class="mb-4">
                <div class="relative">
                    <input 
                        type="text" 
                        id="mobileSearchInput"
                        placeholder="Search devices..." 
                        class="w-full px-4 py-2 pl-10 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-blue-500"
                    >
                    <i data-feather="search" class="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>
            
            <nav class="space-y-4">
                <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                    <i data-feather="activity"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/devices" class="nav-item {% if request.path == '/devices' %}active{% endif %}">
                    <i data-feather="list"></i>
                    <span>Devices</span>
                </a>
                <a href="/alerts" class="nav-item {% if request.path == '/alerts' %}active{% endif %}">
                    <i data-feather="alert-triangle"></i>
                    <span>Alerts</span>
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full" id="mobileAlertCount">0</span>
                </a>
                <a href="/logs" class="nav-item {% if request.path == '/logs' %}active{% endif %}">
                    <i data-feather="clock"></i>
                    <span>Event Logs</span>
                </a>
                <a href="/config" class="nav-item {% if request.path == '/config' %}active{% endif %}">
                    <i data-feather="settings"></i>
                    <span>System Configuration</span>
                </a>
                {% if session.get('is_admin') %}
                <a href="/users" class="nav-item {% if request.path == '/users' %}active{% endif %}">
                    <i data-feather="users"></i>
                    <span>User Management</span>
                </a>
                {% endif %}
            </nav>
            
            <div class="mt-8 cyber-card rounded-lg p-4">
                <h3 class="text-sm font-medium text-slate-400 mb-2">Network Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Devices Online</span>
                        <span class="font-mono text-emerald-400" id="mobileOnlineCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Total Devices</span>
                        <span class="font-mono text-blue-400" id="mobileTotalCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Active Alerts</span>
                        <span class="font-mono text-red-400" id="mobileAlertsCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">New Today</span>
                        <span class="font-mono text-amber-400" id="mobileNewTodayCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
        <aside class="hidden lg:block lg:col-span-1 cyber-card rounded-lg p-4 h-fit">
            <nav class="space-y-4">
                <a href="/" class="nav-item {% if request.path == '/' %}active{% endif %}">
                    <i data-feather="activity"></i>
                    <span>NetWatch SIEM Dashboard</span>
                </a>
                <a href="/devices" class="nav-item {% if request.path == '/devices' %}active{% endif %}">
                    <i data-feather="list"></i>
                    <span>Devices</span>
                </a>
                <a href="/alerts" class="nav-item {% if request.path == '/alerts' %}active{% endif %}">
                    <i data-feather="alert-triangle"></i>
                    <span style="color: red;">Alerts</span>
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full" id="alertCount">0</span>
                </a>
                <a href="/logs" class="nav-item {% if request.path == '/logs' %}active{% endif %}">
                    <i data-feather="clock"></i>
                    <span>Event Logs</span>
                </a>
                <a href="/config" class="nav-item {% if request.path == '/config' %}active{% endif %}">
                    <i data-feather="settings"></i>
                    <span>System Configuration</span>
                </a>
                <a href="{{ url_for('rules_page') }}" class="nav-item">
                    <i data-feather="shield"></i>
                    <span>System Rules</span>
                </a>
                <a href="{{ url_for('analytics_page') }}" class="nav-item">
                    <i data-feather="bar-chart-2"></i>
                    <span>Analytics</span>
                </a>
                {% if session.get('is_admin') %}
                <a href="{{ url_for('users_page') }}" class="nav-item {% if request.path == '/users' %}active{% endif %}">
                    <i data-feather="users"></i>
                    <span>User Management</span>
                </a>
                {% endif %}
            </nav>
            
            <div class="mt-8 cyber-card rounded-lg p-4">
                <h3 class="text-sm font-medium text-slate-400 mb-2">Network Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Devices Online</span>
                        <span class="font-mono text-emerald-400" id="onlineCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Total Devices</span>
                        <span class="font-mono text-blue-400" id="totalCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Active Alerts</span>
                        <span class="font-mono text-red-400" id="alertsCount">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">New Today</span>
                        <span class="font-mono text-amber-400" id="newTodayCount">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="lg:col-span-3 space-y-6">
            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        feather.replace();
        
        const menuToggle = document.getElementById('menuToggle');
        const menuClose = document.getElementById('menuClose');
        const mobileMenu = document.getElementById('mobileMenu');
        
        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.remove('hidden');
            setTimeout(() => feather.replace(), 10);
        });
        
        menuClose.addEventListener('click', () => {
            mobileMenu.classList.add('hidden');
        });
        
        mobileMenu.addEventListener('click', (e) => {
            if (e.target === mobileMenu) {
                mobileMenu.classList.add('hidden');
            }
        });
        
        function updateSidebarStats() {
            fetch('/api/dashboard/stats')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('onlineCount').textContent = data.data.active_devices;
                        document.getElementById('totalCount').textContent = data.data.total_devices;
                        document.getElementById('alertsCount').textContent = data.data.active_alerts;
                        document.getElementById('alertCount').textContent = data.data.active_alerts;
                        document.getElementById('newTodayCount').textContent = data.data.new_today;
                        
                        document.getElementById('mobileOnlineCount').textContent = data.data.active_devices;
                        document.getElementById('mobileTotalCount').textContent = data.data.total_devices;
                        document.getElementById('mobileAlertsCount').textContent = data.data.active_alerts;
                        document.getElementById('mobileAlertCount').textContent = data.data.active_alerts;
                        document.getElementById('mobileNewTodayCount').textContent = data.data.new_today;
                    }
                });
        }

        const scanNowBtn = document.getElementById('scanNowBtn');
        if (scanNowBtn) {
            scanNowBtn.addEventListener('click', function() {
                const btn = this;
                btn.disabled = true;
                const originalText = btn.textContent;
                btn.textContent = 'Scanning...';
                
                fetch('/api/scan/now', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                        
                        if (data.success) {
                            // Show success message
                            const msg = document.createElement('div');
                            msg.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                            msg.textContent = `Scan complete! Found ${data.devices_count || 0} devices.`;
                            document.body.appendChild(msg);
                            setTimeout(() => msg.remove(), 3000);
                            
                            // Update UI immediately
                            const lastScanTime = document.getElementById('lastScanTime');
                            if (lastScanTime) lastScanTime.textContent = 'Just now';
                            
                            // Refresh all data
                            updateSidebarStats();
                            if (window.updatePageData) window.updatePageData();
                            
                            // Force dashboard refresh
                            if (typeof updateDashboardStats === 'function') updateDashboardStats();
                            if (typeof loadDevices === 'function') loadDevices();
                        } else {
                            alert('Scan failed: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                        alert('Scan error: ' + error.message);
                        console.error('Scan error:', error);
                    });
            });
        }

        // Global Search Functionality
        let globalSearchTimeout = null;
        const globalSearchInput = document.getElementById('globalSearchInput');
        const globalSearchResults = document.getElementById('globalSearchResults');
        const globalClearBtn = document.getElementById('globalClearBtn');
        const mobileSearchInput = document.getElementById('mobileSearchInput');

        function performGlobalSearch(query) {
            if (query.length < 2) {
                globalSearchResults.classList.add('hidden');
                return;
            }

            fetch(`/api/devices/search?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        displaySearchResults(data.data);
                    } else {
                        displayNoResults(query);
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    globalSearchResults.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Search error occurred</div>';
                    globalSearchResults.classList.remove('hidden');
                });
        }

        function displaySearchResults(devices) {
            const html = devices.slice(0, 8).map(device => `
                <a href="/devices" class="block px-4 py-3 hover:bg-slate-700 border-b border-slate-700 last:border-b-0">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-feather="${device.status === 'online' ? 'wifi' : 'wifi-off'}" 
                                   class="w-4 h-4 text-${device.status === 'online' ? 'emerald' : 'slate'}-400"></i>
                                <span class="text-slate-200 font-medium">${device.device_name || device.hostname || 'Unknown Device'}</span>
                            </div>
                            <div class="text-xs text-slate-400">
                                <span class="font-mono">${device.ip_address}</span>
                                <span class="mx-2">â€¢</span>
                                <span class="font-mono">${device.mac_address}</span>
                            </div>
                            ${device.vendor ? `<div class="text-xs text-slate-500 mt-1">${device.vendor}</div>` : ''}
                        </div>
                        <div>
                            <span class="status-badge ${device.status === 'online' ? 'status-online' : 'status-offline'} text-xs">
                                ${device.status}
                            </span>
                        </div>
                    </div>
                </a>
            `).join('');

            const footer = devices.length > 8 ? `
                <a href="/devices" class="block px-4 py-3 text-center text-sm text-blue-400 hover:bg-slate-700">
                    View all ${devices.length} results
                </a>
            ` : '';

            globalSearchResults.innerHTML = html + footer;
            globalSearchResults.classList.remove('hidden');
            setTimeout(() => feather.replace(), 10);
        }

        function displayNoResults(query) {
            globalSearchResults.innerHTML = `
                <div class="p-4 text-center">
                    <div class="text-slate-400 text-sm mb-2">No devices found matching</div>
                    <div class="text-slate-300 font-mono text-sm">"${query}"</div>
                    <a href="/devices" class="inline-block mt-3 text-xs text-blue-400 hover:text-blue-300">
                        View all devices
                    </a>
                </div>
            `;
            globalSearchResults.classList.remove('hidden');
        }


        function formatLabel(key) {
    const labelMap = {
        'online_devices': 'Online Devices',
        'trusted': 'Trusted Devices',
        'active_alerts': 'Active Alerts',
        'recent_activity': 'Recent Activity',
        'total_devices': 'Total Devices',
        'health_score': 'Health Score'
    };
    
    return labelMap[key] || key.replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

        function clearGlobalSearch() {
            globalSearchInput.value = '';
            globalClearBtn.classList.add('hidden');
            globalSearchResults.classList.add('hidden');
        }

        if (globalSearchInput) {
            globalSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query) {
                    globalClearBtn.classList.remove('hidden');
                } else {
                    globalClearBtn.classList.add('hidden');
                    globalSearchResults.classList.add('hidden');
                    return;
                }
                
                clearTimeout(globalSearchTimeout);
                globalSearchTimeout = setTimeout(() => {
                    performGlobalSearch(query);
                }, 300);
            });

            globalSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(globalSearchTimeout);
                    performGlobalSearch(e.target.value.trim());
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!globalSearchInput.contains(e.target) && !globalSearchResults.contains(e.target)) {
                    globalSearchResults.classList.add('hidden');
                }
            });
        }

        // Mobile search redirects to devices page
        if (mobileSearchInput) {
            mobileSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `/devices?search=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        updateSidebarStats();
        setInterval(updateSidebarStats, 5000);

        // Language switching functionality
        const languageSelector = document.getElementById('languageSelector');
        if (languageSelector) {
            // Load current language
            fetch('/api/language/current')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        languageSelector.value = data.current_language;
                    }
                });


            // Handle language change
            languageSelector.addEventListener('change', function() {
                const selectedLanguage = this.value;
                
                fetch('/api/language/set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: selectedLanguage })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Reload page to apply new language
                        window.location.reload();
                    }
                })
                .catch(err => console.error('Language change error:', err));
            });
        }
    </script>
    
    <script src="{{ url_for('static', filename='js/realtime.js') }}"></script>
    
    
    {% block scripts %}{% endblock %}
</body>
</html>