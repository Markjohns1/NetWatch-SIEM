{% extends "base.html" %}

{% block title %}Event Logs{% endblock %}

{% block content %}
<div class="cyber-card rounded-lg p-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium">System Event Logs</h2>
        <div class="flex gap-2">
            <button class="text-xs flex items-center px-3 py-2 bg-red-700 hover:bg-red-800 rounded" onclick="deleteAllLogs()">
                <i data-feather="trash" class="w-3 h-3 mr-1"></i>
                Clear All Logs
            </button>
            <button class="text-xs flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded" onclick="window.updatePageData()">
                <i data-feather="refresh-cw" class="w-3 h-3 mr-1"></i>
                Refresh
            </button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="text-slate-400 border-b border-slate-800">
                <tr>
                    <th class="pb-2 text-left">Time</th>
                    <th class="pb-2 text-left">Type</th>
                    <th class="pb-2 text-left">Severity</th>
                    <th class="pb-2 text-left">Description</th>
                    <th class="pb-2 text-left">Device</th>
                </tr>
            </thead>
            <tbody id="logsTableBody" class="divide-y divide-slate-800">
                <tr>
                    <td colspan="5" class="py-4 text-center text-slate-400">Loading logs...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updatePageData() {
        fetch('/api/events')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('logsTableBody');
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(event => `
                        <tr>
                            <td class="py-3 font-mono text-xs">${formatTime(event.timestamp)}</td>
                            <td class="py-3">${event.event_type}</td>
                            <td class="py-3">
                                <span class="px-2 py-1 rounded text-xs ${
                                    event.severity === 'high' ? 'bg-red-500/20 text-red-400' :
                                    event.severity === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                                    'bg-blue-500/20 text-blue-400'
                                }">${event.severity}</span>
                            </td>
                            <td class="py-3">${event.description}</td>
                            <td class="py-3 font-mono text-xs">${event.ip_address || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-slate-400">No events found</td></tr>';
                }
                feather.replace();
            });
    }

    function deleteAllLogs() {
        if (!confirm('Delete ALL event logs? This cannot be undone!')) {
            return;
        }
        
        fetch('/api/events/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updatePageData();
                showNotification(`Deleted ${data.deleted_count} event(s)`, 'success');
            } else {
                showNotification('Error deleting logs', 'error');
            }
        });
    }

    function formatTime(timestamp) {
        try {
            return new Date(timestamp).toLocaleString('en-KE', {
                timeZone: 'Africa/Nairobi',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch {
            return new Date(timestamp).toLocaleString();
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-3 rounded shadow-lg ${
            type === 'success' ? 'bg-emerald-500' : 'bg-red-500'
        } text-white z-50`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }

    window.updatePageData = updatePageData;
    updatePageData();
    setInterval(updatePageData, 10000);
</script>
{% endblock %}